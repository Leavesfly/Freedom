# 认证机制

<cite>
**本文档引用的文件**
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java)
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java)
- [Capabilities.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/Capabilities.java)
- [SecurityUtil.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/SecurityUtil.java)
- [OkPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/OkPacket.java)
- [ErrorPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/ErrorPacket.java)
- [MySQLMessage.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/MySQLMessage.java)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java)
- [ErrorCode.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/ErrorCode.java)
- [Database.java](file://src/main/java/alchemystar/freedom/engine/Database.java)
</cite>

## 目录
1. [简介](#简介)
2. [认证流程概述](#认证流程概述)
3. [AuthPacket解析](#authpacket解析)
4. [客户端能力标志解析](#客户端能力标志解析)
5. [密码验证机制](#密码验证机制)
6. [认证成功处理](#认证成功处理)
7. [认证失败处理](#认证失败处理)
8. [安全性分析](#安全性分析)

## 简介
Freedom数据库的客户端认证机制实现了标准的MySQL协议认证流程，通过握手包、认证包的交互完成客户端身份验证。本机制基于MySQL 4.1协议实现，采用安全的密码加密传输方式，确保认证过程的安全性。

## 认证流程概述
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "服务器"
Server->>Client : 发送HandshakePacket(握手包)
Client->>Server : 发送AuthPacket(认证包)
alt 认证成功
Server->>Server : 验证密码并绑定会话
Server->>Client : 发送OkPacket.AUTH_OK
Server->>Server : 切换Pipeline至FrontendCommandHandler
else 认证失败
Server->>Client : 发送ErrorPacket(错误包)
Server->>Client : 返回ER_ACCESS_DENIED_ERROR
end
```

**图示来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L40-L173)
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java#L15-L119)

## AuthPacket解析
AuthPacket类负责解析客户端发送的认证数据包，包含客户端能力标志、最大包尺寸、字符集索引、用户名、密码和数据库名等信息。

```mermaid
classDiagram
class AuthPacket {
+long clientFlags
+long maxPacketSize
+int charsetIndex
+byte[] extra
+String user
+byte[] password
+String database
+read(BinaryPacket) void
+write(Channel) void
+calcPacketSize() int
}
class MySQLMessage {
+readUB4() long
+read() byte
+readLength() long
+readStringWithNull() String
+readBytesWithLength() byte[]
}
AuthPacket --> MySQLMessage : "使用"
```

**图示来源**
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java#L15-L119)
- [MySQLMessage.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/MySQLMessage.java#L15-L365)

**本节来源**
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java#L15-L119)
- [MySQLMessage.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/MySQLMessage.java#L15-L365)

## 客户端能力标志解析
客户端能力标志（clientFlags）用于标识客户端支持的功能特性，通过位运算进行解析和判断。

```mermaid
flowchart TD
Start([开始解析clientFlags]) --> ReadClientFlags["读取clientFlags字段"]
ReadClientFlags --> CheckConnectWithDB{"CLIENT_CONNECT_WITH_DB<br/>标志位是否设置?"}
CheckConnectWithDB --> |是| ReadDatabaseName["读取数据库名"]
CheckConnectWithDB --> |否| SkipDatabaseName["跳过数据库名读取"]
ReadClientFlags --> ReadMaxPacketSize["读取maxPacketSize"]
ReadClientFlags --> ReadCharsetIndex["读取charsetIndex"]
ReadMaxPacketSize --> ProcessPacketSize["处理最大包尺寸"]
ReadCharsetIndex --> ProcessCharset["处理字符集索引"]
ProcessPacketSize --> End([完成解析])
ProcessCharset --> End
SkipDatabaseName --> End
ReadDatabaseName --> End
```

**图示来源**
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java#L30-L58)
- [Capabilities.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/Capabilities.java#L15-L86)

**本节来源**
- [AuthPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/AuthPacket.java#L30-L58)
- [Capabilities.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/Capabilities.java#L15-L86)

## 密码验证机制
密码验证流程通过FrontendAuthenticator的channelRead方法实现，包括密码解密、比对和用户会话绑定。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Authenticator as "FrontendAuthenticator"
participant Security as "SecurityUtil"
Client->>Authenticator : 发送AuthPacket
Authenticator->>Authenticator : 调用checkPassword方法
Authenticator->>Security : scramble411(密码, seed)
Security-->>Authenticator : 返回加密后的密码
Authenticator->>Authenticator : 比对密码字节数组
alt 密码正确
Authenticator->>Authenticator : 绑定用户会话信息
Authenticator->>Client : 发送认证成功响应
else 密码错误
Authenticator->>Client : 发送认证失败响应
end
```

**图示来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L90-L139)
- [SecurityUtil.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/SecurityUtil.java#L15-L78)

**本节来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L90-L139)
- [SecurityUtil.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/SecurityUtil.java#L15-L78)

## 认证成功处理
认证成功后，系统会切换Netty Pipeline至命令处理程序，并发送OK响应。

```mermaid
flowchart TD
Start([认证成功]) --> ReplaceHandler["替换Pipeline处理器"]
ReplaceHandler --> SetCommandHandler["设置FrontendCommandHandler"]
SetCommandHandler --> SendAuthOK["发送AUTH_OK响应"]
SendAuthOK --> WriteBytes["写入OkPacket.AUTH_OK字节数组"]
WriteBytes --> FlushData["刷新数据到客户端"]
FlushData --> Complete([认证流程完成])
```

**图示来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L141-L150)
- [OkPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/OkPacket.java#L15-L70)

**本节来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L141-L150)
- [OkPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/OkPacket.java#L15-L70)

## 认证失败处理
认证失败时，系统会返回相应的错误码和错误信息。

```mermaid
flowchart TD
Start([认证失败]) --> CreateErrorPacket["创建ErrorPacket"]
CreateErrorPacket --> SetErrorCode["设置错误码ER_ACCESS_DENIED_ERROR"]
SetErrorCode --> SetErrorMessage["设置错误消息"]
SetErrorMessage --> WriteError["写入错误包到通道"]
WriteError --> FlushError["刷新错误响应"]
FlushError --> CloseConnection["关闭连接"]
CloseConnection --> Complete([认证失败流程完成])
```

**图示来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L152-L158)
- [ErrorPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/ErrorPacket.java#L15-L80)
- [ErrorCode.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/ErrorCode.java#L15-L523)

**本节来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L152-L158)
- [ErrorPacket.java](file://src/main/java/alchemystar/freedom/engine/net/proto/mysql/ErrorPacket.java#L15-L80)
- [ErrorCode.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/ErrorCode.java#L15-L523)

## 安全性分析
Freedom数据库的认证机制实现了多层安全保护，确保用户凭证的安全传输和存储。

```mermaid
graph TB
subgraph "安全特性"
A[密码加密传输] --> B[使用SHA-1算法]
A --> C[基于随机seed加密]
D[客户端能力控制] --> E[支持安全连接]
D --> F[协议版本控制]
G[会话信息绑定] --> H[用户身份绑定]
G --> I[连接信息记录]
end
subgraph "安全流程"
J[生成随机seed] --> K[客户端加密密码]
K --> L[服务器端验证]
L --> M[双向验证]
end
安全特性 --> 安全流程
```

**图示来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L40-L88)
- [SecurityUtil.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/SecurityUtil.java#L15-L78)
- [Database.java](file://src/main/java/alchemystar/freedom/engine/Database.java#L15-L78)

**本节来源**
- [FrontendAuthenticator.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendAuthenticator.java#L40-L88)
- [SecurityUtil.java](file://src/main/java/alchemystar/freedom/engine/net/proto/util/SecurityUtil.java#L15-L78)
- [Database.java](file://src/main/java/alchemystar/freedom/engine/Database.java#L15-L78)