# 会话控制命令处理

<cite>
**本文档引用的文件**   
- [BeginHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/BeginHandler.java)
- [SetHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SetHandler.java)
- [KillHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/KillHandler.java)
- [SavepointHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SavepointHandler.java)
- [ServerParse.java](file://src/main/java/alchemystar/freedom/engine/parser/ServerParse.java)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java)
- [TrxManager.java](file://src/main/java/alchemystar/freedom/transaction/TrxManager.java)
- [Trx.java](file://src/main/java/alchemystar/freedom/transaction/Trx.java)
- [TrxState.java](file://src/main/java/alchemystar/freedom/transaction/TrxState.java)
</cite>

## 目录
1. [事务控制命令实现](#事务控制命令实现)
2. [会话配置命令处理](#会话配置命令处理)
3. [连接管理命令机制](#连接管理命令机制)
4. [保存点管理功能](#保存点管理功能)
5. [命令解析与分发机制](#命令解析与分发机制)
6. [事务状态与恢复策略](#事务状态与恢复策略)
7. [连接泄漏防护机制](#连接泄漏防护机制)

## 事务控制命令实现

`BeginHandler`类负责处理事务开始命令，当客户端发送`BEGIN`语句时，系统通过`FrontendConnection`对象执行事务提交并返回成功响应。该处理流程确保了事务的正确启动和状态管理。

```mermaid
sequenceDiagram
participant 客户端
participant BeginHandler
participant FrontendConnection
客户端->>BeginHandler : 发送BEGIN命令
BeginHandler->>FrontendConnection : 调用commit()
FrontendConnection->>FrontendConnection : 执行事务提交
FrontendConnection-->>BeginHandler : 返回确认
BeginHandler-->>客户端 : 写入OK响应
```

**图示来源**
- [BeginHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/BeginHandler.java#L10-L14)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L150-L155)

**本节来源**
- [BeginHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/BeginHandler.java#L10-L14)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L150-L155)

## 会话配置命令处理

`SetHandler`类负责处理`SET`语句，通过解析语句内容来更新会话的各种属性。该处理器支持自动提交模式、事务隔离级别和字符集等关键会话参数的配置。

```mermaid
flowchart TD
Start([开始处理SET命令]) --> Parse["解析SET语句"]
Parse --> CheckResult{"解析结果"}
CheckResult --> |自动提交开启| AutoCommitOn["设置autocommit=true"]
CheckResult --> |自动提交关闭| AutoCommitOff["设置autocommit=false"]
CheckResult --> |读未提交| SetReadUncommitted["设置隔离级别=READ_UNCOMMITTED"]
CheckResult --> |读已提交| SetReadCommitted["设置隔离级别=READ_COMMITTED"]
CheckResult --> |可重复读| SetRepeatableRead["设置隔离级别=REPEATED_READ"]
CheckResult --> |串行化| SetSerializable["设置隔离级别=SERIALIZABLE"]
CheckResult --> |字符集| SetCharset["设置会话字符集"]
AutoCommitOn --> WriteOk["写入OK响应"]
AutoCommitOff --> WriteOk
SetReadUncommitted --> WriteOk
SetReadCommitted --> WriteOk
SetRepeatableRead --> WriteOk
SetSerializable --> WriteOk
SetCharset --> ValidateCharset{"字符集有效?"}
ValidateCharset --> |是| WriteOk
ValidateCharset --> |否| WriteError["写入错误响应"]
WriteError --> End([结束])
WriteOk --> End
```

**图示来源**
- [SetHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SetHandler.java#L20-L80)
- [ServerParseSet.java](file://src/main/java/alchemystar/freedom/engine/parser/ServerParseSet.java)

**本节来源**
- [SetHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SetHandler.java#L20-L80)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L250-L270)

## 连接管理命令机制

`KillHandler`类实现了连接终止功能，允许管理员终止指定的连接或查询线程。该处理器通过连接ID识别目标连接，并执行相应的关闭操作。

```mermaid
sequenceDiagram
participant 客户端
participant KillHandler
participant FrontendConnection
participant FrontendGroupHandler
客户端->>KillHandler : 发送KILL命令
KillHandler->>KillHandler : 解析连接ID
KillHandler->>KillHandler : 验证ID有效性
KillHandler->>KillHandler : 检查是否自杀
KillHandler->>FrontendGroupHandler : 获取目标连接
FrontendGroupHandler-->>KillHandler : 返回连接对象
KillHandler->>FrontendConnection : 调用close()
FrontendConnection->>客户端 : 发送OK响应
FrontendConnection-->>KillHandler : 确认关闭
KillHandler-->>客户端 : 返回操作结果
```

**图示来源**
- [KillHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/KillHandler.java#L10-L55)
- [FrontendGroupHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendGroupHandler.java)

**本节来源**
- [KillHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/KillHandler.java#L10-L55)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L100-L110)

## 保存点管理功能

`SavepointHandler`目前实现了保存点命令的基本框架，但尚未提供完整的保存点管理功能。当前实现会返回不支持该语句的错误信息。

```mermaid
classDiagram
class SavepointHandler {
+static void handle(String stmt, FrontendConnection c)
}
class FrontendConnection {
+void writeErrMessage(int errno, String msg)
}
SavepointHandler --> FrontendConnection : "调用"
```

**图示来源**
- [SavepointHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SavepointHandler.java#L10-L16)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L280-L290)

**本节来源**
- [SavepointHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/SavepointHandler.java#L10-L16)

## 命令解析与分发机制

`ServerParse`类实现了SQL命令的解析和分发机制，通过字符级别的分析确定命令类型，并将其分发到相应的处理器。该机制支持`BEGIN`、`SET`、`KILL`等多种会话控制命令。

```mermaid
flowchart TB
Start([接收SQL语句]) --> ParseChar["逐字符解析"]
ParseChar --> CheckChar{"首字符"}
CheckChar --> |B/b| CheckBegin["检查BEGIN"]
CheckChar --> |C/c| CheckCreateOrCommit["检查CREATE/COMMIT"]
CheckChar --> |K/k| CheckKill["检查KILL"]
CheckChar --> |S/s| CheckSCommands["检查S系列命令"]
CheckBegin --> ValidateBegin{"是BEGIN?"}
ValidateBegin --> |是| ReturnBegin["返回BEGIN类型"]
ValidateBegin --> |否| ReturnOther["返回OTHER"]
CheckCreateOrCommit --> AnalyzeRest["分析后续字符"]
AnalyzeRest --> |CREATE DATABASE| ReturnCreateDB["返回CREATE_DATABASE"]
AnalyzeRest --> |COMMIT| ReturnCommit["返回COMMIT"]
CheckKill --> ValidateKill{"是KILL?"}
ValidateKill --> |是| ReturnKill["返回KILL类型"]
ValidateKill --> |否| ReturnOther
CheckSCommands --> CheckSubCommand{"检查子命令"}
CheckSubCommand --> |SET| ReturnSet["返回SET类型"]
CheckSubCommand --> |SAVEPOINT| ReturnSavepoint["返回SAVEPOINT类型"]
ReturnBegin --> Dispatch["分发到BeginHandler"]
ReturnSet --> Dispatch
ReturnKill --> Dispatch
ReturnSavepoint --> Dispatch
Dispatch --> Execute["执行相应处理"]
Execute --> End([返回响应])
```

**图示来源**
- [ServerParse.java](file://src/main/java/alchemystar/freedom/engine/parser/ServerParse.java#L50-L450)
- [FrontendCommandHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendCommandHandler.java)

**本节来源**
- [ServerParse.java](file://src/main/java/alchemystar/freedom/engine/parser/ServerParse.java#L50-L450)
- [FrontendCommandHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendCommandHandler.java#L40-L60)

## 事务状态与恢复策略

事务管理系统通过`Trx`类和`TrxManager`类协同工作，实现了完整的事务生命周期管理。`TrxManager`负责创建新的事务对象，而`Trx`类管理事务的具体状态和操作。

```mermaid
classDiagram
class TrxManager {
-static AtomicInteger trxIdCount
+static Trx newTrx()
+static Trx newEmptyTrx()
}
class Trx {
-int state
-int trxId
-List<Log> logs
+void begin()
+void commit()
+void rollback()
+void addLog(Log log)
+void undo()
+void redo()
}
class TrxState {
+int TRX_STATE_NOT_STARTED
+int TRX_STATE_ACTIVE
+int TRX_COMMITTED
}
TrxManager --> Trx : "创建"
Trx --> TrxState : "使用"
Trx --> Log : "包含"
```

**图示来源**
- [TrxManager.java](file://src/main/java/alchemystar/freedom/transaction/TrxManager.java#L10-L22)
- [Trx.java](file://src/main/java/alchemystar/freedom/transaction/Trx.java#L10-L120)
- [TrxState.java](file://src/main/java/alchemystar/freedom/transaction/TrxState.java#L5-L18)

**本节来源**
- [TrxManager.java](file://src/main/java/alchemystar/freedom/transaction/TrxManager.java#L10-L22)
- [Trx.java](file://src/main/java/alchemystar/freedom/transaction/Trx.java#L10-L120)
- [TrxState.java](file://src/main/java/alchemystar/freedom/transaction/TrxState.java#L5-L18)

## 连接泄漏防护机制

系统通过`FrontendConnection`类中的空闲状态检测机制来防止连接泄漏。当连接长时间处于空闲状态时，系统会自动关闭该连接以释放资源。

```mermaid
sequenceDiagram
participant Netty
participant FrontendCommandHandler
participant FrontendConnection
loop 每隔一段时间
Netty->>FrontendCommandHandler : 触发IdleStateEvent
FrontendCommandHandler->>FrontendCommandHandler : 检查空闲状态
FrontendCommandHandler->>FrontendConnection : 获取最后活动时间
FrontendCommandHandler->>FrontendCommandHandler : 计算空闲时长
FrontendCommandHandler->>FrontendCommandHandler : 对比超时阈值
alt 超过阈值
FrontendCommandHandler->>FrontendConnection : 调用close()
FrontendConnection->>Netty : 关闭通道
end
end
```

**图示来源**
- [FrontendCommandHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendCommandHandler.java#L70-L85)
- [FrontendConnection.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendConnection.java#L300-L310)

**本节来源**
- [FrontendCommandHandler.java](file://src/main/java/alchemystar/freedom/engine/net/handler/frontend/FrontendCommandHandler.java#L70-L85)
- [SystemConfig.java](file://src/main/java/alchemystar/freedom/config/SystemConfig.java)